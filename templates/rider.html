<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rider App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #111827; color: #f3f4f6; }
        #map { height: 50vh; width: 100%; z-index: 0; background: #111827; }
        .glass-panel { background: rgba(31, 41, 55, 0.95); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.1); }
        .tab-active { border-bottom: 3px solid #eab308; color: #eab308; font-weight: bold; }
        .tab-inactive { color: #9ca3af; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="p-4 bg-gray-900 border-b border-gray-800 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold text-white">
                <i class="fas fa-user"></i>
            </div>
            <h1 class="font-bold text-white" id="user-name">Rider</h1>
        </div>
        <div class="text-xs bg-green-900/30 text-green-400 px-2 py-1 rounded border border-green-800">ONLINE</div>
    </div>

    <div class="relative w-full z-0"><div id="map"></div></div>

    <div class="glass-panel rounded-t-3xl -mt-6 z-30 shadow-2xl flex-1 flex flex-col pb-10">
        <div class="flex border-b border-gray-700">
            <button onclick="switchTab('book')" id="tab-book" class="flex-1 py-4 text-sm tab-active">üìç Book</button>
            <button onclick="switchTab('sub')" id="tab-sub" class="flex-1 py-4 text-sm tab-inactive">üìÖ Schedule</button>
        </div>

        <div id="view-book" class="p-6 space-y-5">
            <div class="space-y-4">
                <select id="start" onchange="updateRoute()" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white"></select>
                <select id="drop" onchange="updateRoute()" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white"></select>
            </div>
            <button onclick="getEstimate()" class="w-full bg-white text-black font-bold py-3 rounded-xl">Check Prices</button>
            
            <div id="price-box" class="hidden grid grid-cols-2 gap-4">
                <div onclick="requestRide('solo')" class="bg-gray-800 p-4 rounded-xl border border-gray-600 cursor-pointer hover:border-yellow-500">
                    <div class="text-xs text-gray-400 uppercase">Solo</div>
                    <div id="cost-solo" class="text-xl font-bold text-white">--</div>
                </div>
                <div onclick="requestRide('pool')" class="bg-gray-800 p-4 rounded-xl border border-gray-600 cursor-pointer hover:border-blue-500">
                    <div class="text-xs text-gray-400 uppercase">Pool (Cheap)</div>
                    <div id="cost-pool" class="text-xl font-bold text-white">--</div>
                </div>
            </div>
        </div>

        <div id="view-sub" class="hidden p-6 space-y-4">
            <h2 class="text-lg font-bold text-white">Schedule Ride</h2>
            <input type="date" id="sub-date" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white">
            <input type="time" id="sub-time" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white" value="09:00">
            <div id="day-selector" class="flex flex-wrap gap-2 text-sm"></div>
            <select id="sub-mode" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white">
                <option value="pool">Pool</option><option value="solo">Solo</option>
            </select>
            <button onclick="buySubscription()" class="w-full bg-yellow-500 text-black font-bold py-3 rounded-xl">Confirm</button>
        </div>
    </div>

    <div id="driver-sheet" class="fixed bottom-0 left-0 w-full bg-gray-800 rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-500 z-50 p-6 border-t border-gray-700">
        <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center"><i class="fas fa-user text-white"></i></div>
            <div>
                <h2 class="text-lg font-bold text-white" id="sheet-driver-name">Driver</h2>
                <p class="text-sm text-gray-400" id="sheet-vehicle">--</p>
                <div id="sheet-arrival-box" class="mt-1 px-2 py-0.5 rounded text-xs font-bold bg-green-900/30 text-green-400 border border-green-800 inline-block">
                    On the way
                </div>
            </div>
        </div>
        <div class="p-4 bg-gray-900/50 rounded-xl text-center text-gray-300 text-sm" id="sheet-status-text">
            Connecting...
        </div>
    </div>

    <script>
        const riderId = {{ id }};
        const ws = new WebSocket(`ws://${window.location.host}/ws/rider/${riderId}`);
        const map = L.map('map', {zoomControl:false}).setView([12.971, 77.594], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        let lg = L.layerGroup().addTo(map);

        // Fetch Name
        fetch(`/api/client/${riderId}`).then(r=>r.json()).then(d => document.getElementById('user-name').innerText = d.name || "Rider");

        // Init Data
        async function init() {
            const res = await fetch('/config/locations');
            const locs = await res.json();
            const s=document.getElementById('start'), d=document.getElementById('drop');
            for(const [k,v] of Object.entries(locs)) {
                s.innerHTML += `<option value="${k}">${v}</option>`;
                d.innerHTML += `<option value="${k}">${v}</option>`;
            }
            s.value="1"; d.value="5"; 
            document.getElementById('sub-date').valueAsDate = new Date();
            ["Mon","Tue","Wed","Thu","Fri"].forEach(d => document.getElementById('day-selector').innerHTML += `<label class="text-gray-400"><input type="checkbox" value="${d.toLowerCase()}" checked> ${d}</label>`);
        }
        init();

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === 'price_estimate') {
                document.getElementById('price-box').classList.remove('hidden');
                document.getElementById('cost-solo').innerText = "‚Çπ" + data.solo;
                document.getElementById('cost-pool').innerText = "‚Çπ" + data.pool;
            } 
            else if (data.type === 'driver_assigned') {
                const sheet = document.getElementById('driver-sheet');
                sheet.classList.remove('translate-y-full');
                document.getElementById('sheet-driver-name').innerText = data.driver_name;
                document.getElementById('sheet-vehicle').innerText = data.vehicle;
                document.getElementById('sheet-arrival-box').innerText = `Arriving in ${data.arrival} mins`;
                document.getElementById('sheet-status-text').innerText = "Driver assigned!";
            }
            else if (data.type === 'status_update') {
                // SEQUENTIAL UPDATES
                const pill = document.getElementById('sheet-arrival-box');
                const box = document.getElementById('sheet-status-text');
                
                if (data.status === 'arrived') {
                    pill.innerText = "Waiting";
                    pill.className = "mt-1 px-2 py-0.5 rounded text-xs font-bold bg-orange-900/30 text-orange-400 border border-orange-800 inline-block";
                    box.innerText = "Captain is waiting at pickup location.";
                } else if (data.status === 'in_progress') {
                    pill.innerText = "On Trip";
                    pill.className = "mt-1 px-2 py-0.5 rounded text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-800 inline-block";
                    box.innerText = data.detail; // Shows ETA
                }
            }
            else if (data.type === 'ride_completed') {
                alert("Ride Completed!"); location.reload();
            }
        };

        function getEstimate() {
            const s=parseInt(document.getElementById('start').value), d=parseInt(document.getElementById('drop').value);
            ws.send(JSON.stringify({"action":"get_price_estimate","start_zone":s,"drop_zone":d}));
        }
        function requestRide(type) {
            const s=parseInt(document.getElementById('start').value), d=parseInt(document.getElementById('drop').value);
            ws.send(JSON.stringify({"action":"request_ride","start_zone":s,"drop_zone":d,"ride_type":type}));
        }
        function switchTab(t) {
            ['book','sub','hist'].forEach(k => {
                document.getElementById('view-'+k).classList.add('hidden');
                document.getElementById('tab-'+k).classList.remove('tab-active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).classList.add('tab-active');
        }
        async function buySubscription() {
            // (Same fetch logic as before)
            const s = parseInt(document.getElementById('start').value);
            const d = parseInt(document.getElementById('drop').value);
            const date = document.getElementById('sub-date').value;
            const time = document.getElementById('sub-time').value;
            const mode = document.getElementById('sub-mode').value;
            const checks = document.querySelectorAll('#day-selector input:checked');
            const selectedDays = Array.from(checks).map(c => c.value);

            await fetch('/bookings/', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                client_id:riderId, start_zone:s, drop_zone:d, days_of_week:selectedDays, time_of_day:time+":00", start_date:date, monthly_price:3000, ride_mode:mode
            })});
            alert("‚úÖ Scheduled!");
        }
    </script>
</body>
</html>