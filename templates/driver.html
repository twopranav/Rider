<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CHANGED: Allow body to scroll */
        body { background-color: #111827; color: #f3f4f6; }
        
        /* Map stays at the top */
        #map { height: 50vh; width: 100%; z-index: 0; background: #111827; position: sticky; top: 0; }
        
        .glass-panel { 
            background: rgba(17, 24, 39, 0.98); 
            backdrop-filter: blur(15px); 
            border-top: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            min-height: 60vh; /* Ensure it covers bottom half even if empty */
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .ride-card { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans overflow-y-auto">

    <div class="fixed top-0 w-full p-4 flex justify-between items-center z-50 bg-gradient-to-b from-gray-900/90 to-transparent pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-3 bg-gray-900/80 backdrop-blur px-4 py-2 rounded-full border border-gray-700 shadow-lg">
            <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-black font-bold">
                <i class="fas fa-taxi"></i>
            </div>
            <div>
                <h1 id="driver-name" class="text-sm font-bold text-white leading-none">Captain #{{ id }}</h1>
                <span id="driver-vehicle" class="text-[10px] text-gray-400">Loading...</span>
            </div>
        </div>

        <div class="pointer-events-auto px-3 py-1 bg-green-900/80 border border-green-500/30 text-green-400 text-xs font-bold rounded-full shadow-[0_0_10px_rgba(74,222,128,0.2)]">
            ‚óè ONLINE
        </div>
    </div>

    <div class="relative w-full z-0 group">
        <div id="map"></div>
    </div>

    <div class="glass-panel flex-1 flex flex-col rounded-t-3xl -mt-8 z-30 relative pb-10">
        <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mt-3 mb-2 opacity-50"></div>
        
        <div class="px-6 py-2 border-b border-gray-800 flex justify-between items-end">
            <h2 class="text-lg font-bold text-gray-200">Available Rides</h2>
            <span class="text-xs text-gray-500 mb-1">Live Feed</span>
        </div>

        <div id="feed-container" class="p-4 flex-1 space-y-4">
            
            <div id="vip-section" class="hidden">
                <div class="flex items-center gap-2 mb-2 px-1">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                    <h3 class="text-xs font-black text-yellow-500 uppercase tracking-widest">Priority Requests</h3>
                </div>
                <div id="vip-feed" class="space-y-3"></div>
                <div class="h-px bg-gray-800 my-4"></div>
            </div>

            <div id="standard-section">
                <div class="flex items-center gap-2 mb-2 px-1 opacity-50">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Standard Rides</h3>
                </div>
                <div id="feed" class="space-y-3 pb-20">
                    <div class="text-center text-gray-500 text-sm mt-10 animate-pulse" id="empty-msg">
                        Scanning for passengers...
                    </div>
                </div>
            </div>
        </div>

        <div id="active-panel" class="hidden absolute inset-0 bg-gray-900 z-50 p-6 flex flex-col justify-center text-center rounded-t-3xl min-h-[500px]">
            <div class="mb-8">
                <div class="w-20 h-20 bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/30">
                    <i class="fas fa-location-arrow text-3xl text-green-500 animate-pulse"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">Trip In Progress</h2>
                <p class="text-gray-400 text-sm mt-2">Follow GPS to destination</p>
            </div>

            <button id="btn-arrived" onclick="updateStatus('driver_arrived')" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-4 rounded-xl font-bold border border-gray-600 mb-3 transition-all">
                üìç Arrived at Pickup
            </button>
            <button id="btn-start" onclick="updateStatus('start_trip')" class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold mb-3 shadow-lg shadow-blue-900/20 transition-all">
                ‚ñ∂Ô∏è Start Trip
            </button>
            <button id="btn-complete" onclick="updateStatus('complete_ride')" class="hidden w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all">
                ‚úÖ Complete & Collect
            </button>
        </div>
    </div>

    <script>
        const driverId = {{ id }};
        const ws = new WebSocket(`ws://${window.location.host}/ws/driver/${driverId}`);
        
        const map = L.map('map', {zoomControl: false}).setView([12.9716, 77.5946], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        const declinedRides = new Set(); 

        async function fetchDriverDetails() {
            try {
                const res = await fetch(`/api/driver/${driverId}`);
                const data = await res.json();
                if (data) {
                    document.getElementById('driver-name').innerText = data.name;
                    document.getElementById('driver-vehicle').innerText = data.vehicle_number;
                }
            } catch (e) {
                console.error("Could not fetch driver details", e);
            }
        }
        fetchDriverDetails();

        function renderCard(ride, containerId) {
            if(document.getElementById(`ride-${ride.queue_position}`)) return;
            if(declinedRides.has(ride.queue_position)) return;

            const container = document.getElementById(containerId);
            const emptyMsg = document.getElementById('empty-msg');
            if(emptyMsg && containerId === 'feed') emptyMsg.style.display = 'none';

            const card = document.createElement('div');
            card.id = `ride-${ride.queue_position}`;
            card.className = "ride-card relative overflow-hidden rounded-xl border mb-3 transition-all duration-300";

            const isGold = (ride.ui_class === 'card-gold');

            if (isGold) {
                card.classList.add('bg-gradient-to-br', 'from-yellow-900/80', 'to-gray-900', 'border-yellow-500', 'shadow-[0_0_20px_rgba(234,179,8,0.2)]');
            } else {
                card.classList.add('bg-gray-800/60', 'border-gray-700');
            }

            card.innerHTML = `
                <div class="p-4 relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-white text-lg leading-tight">${ride.client_name}</h3>
                                ${isGold ? '<span class="bg-yellow-500 text-black text-[10px] font-extrabold px-1.5 py-0.5 rounded animate-pulse">‚ö° PRIORITY</span>' : ''}
                            </div>
                            <span class="text-xs text-gray-400">ID: ${ride.client_id}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold ${isGold ? 'text-yellow-400' : 'text-green-400'}">‚Çπ${ride.price}</div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Earnings</div>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                            <span class="text-sm font-medium text-gray-200">${ride.from}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
                            <span class="text-sm font-medium text-gray-200">${ride.to}</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="decline(${ride.queue_position})" class="flex-1 py-3 rounded-lg font-bold text-sm text-gray-400 bg-gray-900/50 hover:bg-gray-800 border border-gray-700 transition-colors">DECLINE</button>
                        <button onclick="accept(${ride.queue_position})" class="flex-[2] py-3 rounded-lg font-bold text-sm text-black shadow-lg transition-transform active:scale-95 ${isGold ? 'bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-300 hover:to-yellow-500' : 'bg-white hover:bg-gray-100'}">ACCEPT RIDE</button>
                    </div>
                </div>
            `;
            container.prepend(card);
        }

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.type === 'new_ride' || data.type === 'queue_update') fetchQueue();
        }

        async function fetchQueue() {
            try {
                const res = await fetch(`/rides/queue?driver_id=${driverId}`);
                const data = await res.json();
                
                // Handle VIP
                const vipSection = document.getElementById('vip-section');
                if (data.vip && data.vip.length > 0) {
                    vipSection.classList.remove('hidden');
                    data.vip.forEach(ride => renderCard(ride, 'vip-feed'));
                } else {
                    if(document.getElementById('vip-feed').children.length === 0) vipSection.classList.add('hidden');
                }

                // Handle Standard
                const feed = document.getElementById('feed');
                if (data.standard && data.standard.length > 0) {
                    data.standard.forEach(ride => renderCard(ride, 'feed'));
                } else {
                    if(feed.children.length <= 1) { 
                         document.getElementById('empty-msg').style.display = 'block';
                    }
                }
            } catch(e) { console.error(e); }
        }

        function accept(id) {
            ws.send(JSON.stringify({ "action": "accept_ride", "ride_id": id }));
            document.getElementById('feed-container').classList.add('hidden');
            document.getElementById('active-panel').classList.remove('hidden');
        }

        function decline(id) {
            declinedRides.add(id);
            ws.send(JSON.stringify({ "action": "decline_ride", "ride_id": id }));
            const card = document.getElementById(`ride-${id}`);
            if(card) {
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                setTimeout(() => card.remove(), 300);
            }
        }

        function updateStatus(action) {
            ws.send(JSON.stringify({ "action": action }));
            if (action === 'driver_arrived') {
                document.getElementById('btn-arrived').classList.add('hidden');
                document.getElementById('btn-start').classList.remove('hidden');
            } else if (action === 'start_trip') {
                document.getElementById('btn-start').classList.add('hidden');
                document.getElementById('btn-complete').classList.remove('hidden');
            } else if (action === 'complete_ride') {
                location.reload();
            }
        }

        fetchQueue();
        setInterval(fetchQueue, 3000);
    </script>
</body>
</html>